<?xml version="1.0" encoding="utf-8" ?>
<diff xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <add sel="//init/create_group[@groupname='$miningtargets']" pos="after">    
    <create_group groupname="$targets_mine"/>
  </add>

  <add sel="/aiscript/attention[@min='visible']/actions/set_value[@name='$scantime']" pos="after">
    <do_if value="$turretmodes.indexof.{weaponmode.prefermissiles}">
      <clear_group group="$targets_mine"/>
      <find_object groupname="$targets_mine" class="class.mine" space="this.sector" multiple="true">
        <match_distance object="this.ship" max="this.ship.maxcombatrange.{weaponmode.prefermissiles}.turrets">
          <match owner="this.ship.owner" negate="true" />
        </match_distance>
      </find_object>      
      
      <do_all exact="$targets_mine.count" counter="$m" reverse="true">            
        <set_value name="$mine" exact="$targets_mine.{$m}"/>
        <do_if value="($mine.isfriendfoe and not $mine.foelist.indexof.{this.ship.owner})">
          <remove_from_group group="$targets_mine" object="$mine" />
        </do_if>
        <do_else>
          <add_to_group groupname="$targets" object="$mine"/>
        </do_else>
        <remove_value name="$mine" />
      </do_all>
      <debug_text text="'Scuffle Mine Defence found %s hostile mines.'.[$targets_mine.count]" chance="100"/>
    </do_if>
  </add>

  <replace sel="/aiscript/attention[@min='visible']/actions/do_if[@value='this.ship.assignedpilot and (@$targets.count or $dronetargets.count or ($miningtargets.count and this.ship == player.occupiedship))']/do_else/do_if[@value='$targets.count']/do_if[@value='$turretmodes.indexof.{weaponmode.prefermissiles}']">
    <create_list name="$loctargets"/>
    <append_list_elements name="$loctargets" group="$incomingmissiles"/>
    <append_list_elements name="$loctargets" group="$targets_mine"/>
    <append_list_elements name="$loctargets" group="$targets_fighters"/>
    <append_list_elements name="$loctargets" group="$targets_capital"/>
    <debug_text text="'Scuffle Mine Defence prefer missiles logic found %s total targets: %s missiles, %s mines, %s fighters, and %s capitals'.[$loctargets.count,$incomingmissiles.count,$targets_mine.count,$targets_fighters.count,$targets_capital.count]" chance="100"/>
    <set_value name="$locpreferred" exact="$preferredtarget"/>
    <do_if value="$incomingmissiles.count and (not $locpreferred or not $incomingmissiles.indexof.{$locpreferred})">
      <set_value name="$locpreferred" exact="$incomingmissiles.random"/>
    </do_if>      
    <do_elseif value="$targets_mine.count and (not $locpreferred or not $targets_mine.indexof.{$locpreferred})">
      <set_value name="$locpreferred" exact="$targets_mine.random"/>
      <debug_text text="'Scuffle Mine Defence added a mine as the primary target for a turret.'" chance="100"/>
    </do_elseif>
    <set_turret_targets object="this.assignedcontrolled" target="$loctargets" weaponmode="weaponmode.prefermissiles" preferredtarget="$locpreferred"/>
    <remove_value name="$loctargets"/>
  </replace>
</diff>